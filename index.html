<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bookmarklet Kode OTP ‚Äî Google Authenticator QR Decoder</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --muted:#94a3b8;
    --accent:#7c3aed;
    --accent-2:#06b6d4;
    --glass: rgba(255,255,255,0.04);
    --success:#10b981;
    --danger:#ef4444;
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: linear-gradient(180deg, #071021 0%, #0f1724 60%);
    color:#e6eef8;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    padding:28px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .wrap{
    max-width:1100px;
    margin: 0 auto;
  }

  header{
    display:flex;
    gap:16px;
    align-items:center;
    margin-bottom:20px;
  }
  .brand {
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo{
    width:56px;height:56px;border-radius:12px;
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;
    box-shadow: 0 6px 20px rgba(124,58,237,0.18), inset 0 -6px 12px rgba(255,255,255,0.03);
    font-weight:700;font-family: "Roboto Mono", monospace;
  }
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .grid{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:20px;
    align-items:start;
  }
  @media (max-width:960px){
    .grid{grid-template-columns:1fr}
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:var(--radius);
    padding:18px;
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.03);
  }

  /* Left panel */
  .uploader{
    display:flex;
    gap:18px;
    align-items:flex-start;
  }
  .dropzone{
    flex:1;
    border-radius:10px;
    padding:16px;
    background:var(--glass);
    border: 1px dashed rgba(255,255,255,0.04);
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
    justify-content:center;
    min-height:220px;
    transition:all .18s ease;
    text-align:center;
  }
  .dropzone.dragover{transform:translateY(-4px); box-shadow: 0 10px 30px rgba(8,12,20,0.6); border-color: rgba(124,58,237,0.9)}
  .dropzone input[type=file]{display:none}
  .btn{
    display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#5b21b6);color:white;border:none;cursor:pointer;font-weight:600;
  }
  .muted{color:var(--muted);font-size:13px}
  .preview{
    width:150px;height:150px;border-radius:8px;background:#071027;border:1px solid rgba(255,255,255,0.03);
    display:flex;align-items:center;justify-content:center;overflow:hidden;
  }
  .preview img{width:100%;height:100%;object-fit:cover}

  /* Right panel */
  .panel-right{display:flex;flex-direction:column;gap:12px}
  .field{display:flex;flex-direction:column;gap:8px}
  label{font-size:13px;color:var(--muted)}
  input[type="text"], .small-input{
    padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:inherit;font-family: "Roboto Mono", monospace;
  }
  .radio-row{display:flex;gap:8px;flex-wrap:wrap}
  .radio-row label{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:10px;cursor:pointer}
  button.action{
    background:linear-gradient(90deg,var(--accent-2),var(--accent));
    padding:10px 12px;border-radius:10px;border:none;color:black;font-weight:700;cursor:pointer;
  }

  .accounts-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .acct{
    display:flex;justify-content:space-between;gap:12px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02)
  }
  .acct .meta{display:flex;gap:12px;align-items:center}
  .acct .meta .name{font-weight:600}
  .chip{font-family:"Roboto Mono",monospace;background:rgba(0,0,0,0.25);padding:6px 8px;border-radius:8px;font-size:13px}

  .row{display:flex;gap:8px;align-items:center}
  .small{
    font-size:13px;color:var(--muted)
  }

  /* output area (console-like) */
  #outputConsole{
    margin-top:12px;background:#041024;padding:12px;border-radius:10px;font-family:"Roboto Mono",monospace;color:#cfeeea;white-space:pre-wrap;
    max-height:240px;overflow:auto;font-size:13px;border:1px solid rgba(255,255,255,0.02);
  }

  /* footer */
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

  /* toast */
  .toast{
    position:fixed;right:20px;bottom:20px;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:black;padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 12px 40px rgba(2,6,23,0.6);transform:translateY(20px);opacity:0;transition:all .28s;
  }
  .toast.show{opacity:1;transform:none}
  .copy-btn{background:transparent;border:none;color:var(--accent-2);cursor:pointer;font-weight:700;padding:6px 8px;border-radius:8px}
  .copy-btn:hover{background:rgba(255,255,255,0.02)}
  .success-pill{background:rgba(16,185,129,0.12);color:var(--success);padding:6px 8px;border-radius:8px;font-weight:600}
  .error-pill{background:rgba(239,68,68,0.08);color:var(--danger);padding:6px 8px;border-radius:8px;font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">OTP</div>
        <div>
          <h1>Bookmarklet Kode OTP</h1>
          <p class="lead">Google Authenticator QR Decoder & Bookmarklet Generator ‚Äî aman, cepat, dan mudah</p>
        </div>
      </div>
      <div style="margin-left:auto;color:var(--muted);font-size:13px">
        ‚≠ê by: Abdul Mudhar ‚≠ê
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <h3 style="margin:0 0 8px 0">üîç Google Authenticator QR Decoder</h3>
        <p class="muted" style="margin-top:0">Unggah gambar kode QR 2FA atau drop file untuk mengekstrak akun (mendukung format migrasi Google Authenticator dan otpauth:// URL).</p>

        <div class="uploader" style="margin-top:12px">
          <div class="dropzone" id="dropzone">
            <div style="width:100%;display:flex;flex-direction:column;gap:8px;align-items:center">
              <svg width="56" height="56" viewBox="0 0 24 24" fill="none" style="opacity:0.95">
                <path d="M12 3v10" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 10l7-7 7 7" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <rect x="3" y="12" width="18" height="9" rx="2" stroke="white" stroke-width="1.2" fill="rgba(255,255,255,0.02)"/>
              </svg>
              <div style="font-weight:700">Tarik dan lepas file di sini</div>
              <div class="muted">atau pilih file secara manual</div>
              <label class="btn" for="fileInput">Pilih File</label>
              <input id="fileInput" type="file" accept="image/*">
            </div>
          </div>

          <div style="width:170px;display:flex;flex-direction:column;gap:12px">
            <div class="preview" id="imgPreview">
              <div class="muted">Preview</div>
            </div>
            <div style="display:flex;gap:8px;flex-direction:column">
              <div class="small muted">Hasil decode:</div>
              <div id="outputConsole">Silakan upload QR Google Authenticator atau otpauth URL.</div>
            </div>
          </div>
        </div>

        <div class="accounts-list" id="accountsList" aria-live="polite"></div>
      </section>

      <aside class="card panel-right">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0">üîó Generator Bookmarklet</h3>
            <div class="muted" style="margin-top:6px">Ambil secret dari hasil decode, masukkan nama, pilih target field, lalu buat bookmarklet.</div>
          </div>
        </div>

        <div class="field">
          <label>Secret (Base32) ‚Äî hasil decode</label>
          <input id="bookmarkletCode" class="small-input" type="text" placeholder="Masukkan atau klik 'Copy Secret' dari hasil decode">
        </div>

        <div class="field">
          <label>Nama Bookmarklet</label>
          <input id="bookmarkletNama" class="small-input" type="text" placeholder="Contoh: OTP ‚Äî Dapodik">
        </div>

        <div class="field">
          <label>Pilih penggunaan OTP (field id pada halaman target)</label>
          <div class="radio-row">
            <label><input type="radio" name="bmOption" value="kode2fa" checked> Dapodik (id: kode2fa)</label>
            <label><input type="radio" name="bmOption" value="totp_code"> SDM (id: totp_code)</label>
            <label><input type="radio" name="bmOption" value="infogtk"> InfoGTK (special)</label>
            <label><input type="radio" name="bmOption" value="otp"> SIASN (id: otp)</label>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <button class="action" id="generateBtn">Generate Bookmarklet</button>
          <button class="btn" id="sampleBtn" title="Contoh QR sample">Contoh QR</button>
        </div>

        <div style="margin-top:12px">
          <div style="font-size:13px;color:var(--muted)">Bookmarklet:</div>
          <a id="bookmarkletLink" class="chip" href="#" target="_blank" style="display:inline-block;margin-top:8px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></a>
          <div style="margin-top:8px" class="small muted">Tarik link ini ke bookmarks bar, atau klik lalu simpan sebagai bookmark.</div>
        </div>

        <div style="margin-top:18px">
          <div class="muted" style="margin-bottom:8px">Contoh TOTP dari secret (pratinjau):</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="chip" id="totpPreview">‚Äî</div>
            <button class="copy-btn" id="regenTotp">Generate</button>
            <div class="small muted">Periode 30s, 6 digit</div>
          </div>
        </div>

        <div id="helper" style="margin-top:12px;font-size:13px;color:var(--muted)">
          Tip: Gunakan tombol "Copy Secret" pada hasil decode untuk langsung mengisi field Secret di sini.
        </div>
      </aside>
    </main>

    <footer>
      <div class="muted">Selalu simpan secret Anda dengan aman. Aplikasi ini hanya membantu ekstraksi. Tidak menyimpan data ke server.</div>
    </footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
/* Utility & UI helpers */
const fileInput = document.getElementById('fileInput');
const dropzone = document.getElementById('dropzone');
const preview = document.getElementById('imgPreview');
const outputConsole = document.getElementById('outputConsole');
const accountsList = document.getElementById('accountsList');
const toast = document.getElementById('toast');

function showToast(msg, timeout=3000){
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.classList.remove('show'), timeout);
}

function setPreviewImage(src){
  preview.innerHTML = '';
  const img = document.createElement('img');
  img.src = src;
  img.alt = 'preview';
  preview.appendChild(img);
}

/* Drag & drop */
['dragenter','dragover'].forEach(ev=>{
  dropzone.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation();
    dropzone.classList.add('dragover');
  });
});
['dragleave','drop'].forEach(ev=>{
  dropzone.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation();
    dropzone.classList.remove('dragover');
  });
});
dropzone.addEventListener('drop', e=>{
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f) handleFileObject(f);
});

/* File input */
fileInput.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(f) handleFileObject(f);
});

/* Core: read file, decode QR */
function handleFileObject(file){
  const reader = new FileReader();
  reader.onload = function(evt){
    const src = evt.target.result;
    setPreviewImage(src);
    const img = new Image();
    img.onload = function(){
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0);
      try {
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if(code && code.data){
          processQR(code.data);
        } else {
          // Try to read QR via fallback: sometimes smaller area
          outputConsole.textContent = '‚ö†Ô∏è QR tidak terbaca otomatis. Mencoba baca dari URL teks pada gambar...';
          // fallback: try decode from embedded text (rare). For now show message.
          showToast('QR tidak terbaca. Pastikan gambar jelas & resolusi cukup.',3500);
          outputConsole.textContent = '‚ùå QR code tidak terbaca.';
        }
      } catch(err){
        outputConsole.textContent = '‚ùå Error memproses gambar: ' + err.message;
      }
    };
    img.onerror = function(){ outputConsole.textContent = '‚ùå Gagal memuat gambar.' };
    img.src = src;
  };
  reader.readAsDataURL(file);
}

/* Parsing logic (supports otpauth:// and Google Authenticator migration) */
function processQR(qrText){
  try {
    accountsList.innerHTML = '';
    outputConsole.textContent = '';
    // If plain otpauth://
    if (qrText.startsWith("otpauth://")) {
      const url = new URL(qrText);
      const secret = url.searchParams.get("secret");
      const issuer = url.searchParams.get("issuer") || "(tidak ada)";
      // label can be in pathname or label param
      let label = decodeURIComponent(url.pathname.replace(/^\//,''));
      if(!label) label = url.searchParams.get('label') || "(tidak ada)";
      const item = {
        name: label,
        issuer,
        secret
      };
      renderAccount(item);
      outputConsole.textContent = `üìå OTP Auth\nNama: ${label}\nIssuer: ${issuer}\nSecret: ${secret || '(tidak ditemukan)'}`;
      return;
    }

    // Otherwise try parse migration format: it encodes protobuf payload in data param
    const url = new URL(qrText);
    let dataParam = url.searchParams.get("data");
    if(!dataParam){
      outputConsole.textContent = "‚ö†Ô∏è Parameter data= tidak ditemukan di URL QR.";
      return;
    }

    // Normalisasi (spaces etc.)
    dataParam = dataParam.replace(/ /g, '+').replace(/%20/g, '+').replace(/%2B/gi, '+');
    const binary = atob(dataParam);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

    const root = protobuf.Root.fromJSON({
      nested: {
        MigrationPayload: {
          fields: {
            otpParameters: { rule: "repeated", type: "OtpParameters", id: 1 },
            version: { type: "int32", id: 2 },
            batchSize: { type: "int32", id: 3 },
            batchIndex: { type: "int32", id: 4 },
            batchId: { type: "bytes", id: 5 }
          }
        },
        OtpParameters: {
          fields: {
            secret: { type: "bytes", id: 1 },
            name: { type: "string", id: 2 },
            issuer: { type: "string", id: 3 },
            algorithm: { type: "int32", id: 4 },
            digits: { type: "int32", id: 5 },
            type: { type: "int32", id: 6 },
            counter: { type: "int64", id: 7 }
          }
        }
      }
    });

    const MigrationPayload = root.lookupType("MigrationPayload");
    const payload = MigrationPayload.decode(bytes);

    if(!payload.otpParameters || payload.otpParameters.length === 0){
      outputConsole.textContent = "‚ö†Ô∏è Tidak ada akun ditemukan di payload migrasi.";
      return;
    }

    outputConsole.textContent = `‚úÖ Mendapatkan ${payload.otpParameters.length} akun:\n`;
    payload.otpParameters.forEach((param, i) => {
      const secretBase32 = base32Encode(param.secret);
      const name = param.name || "(tidak ada)";
      const issuer = param.issuer || "(tidak ada)";
      outputConsole.textContent += `\n[${i+1}] ${issuer} - ${name}\nSecret: ${secretBase32}\n`;
      renderAccount({name, issuer, secret: secretBase32});
    });

  } catch(err){
    outputConsole.textContent = "‚ùå Error: " + (err && err.message ? err.message : String(err));
  }
}

/* Render each account with copy buttons */
function renderAccount(item){
  const div = document.createElement('div');
  div.className = 'acct';
  const meta = document.createElement('div');
  meta.className = 'meta';
  const bc = document.createElement('div');
  bc.innerHTML = `<div style="display:flex;flex-direction:column"><div class="name">${escapeHtml(item.issuer)} ‚Äî ${escapeHtml(item.name)}</div><div class="muted small">${item.secret}</div></div>`;
  meta.appendChild(bc);

  const actions = document.createElement('div');
  actions.style.display = 'flex';
  actions.style.gap = '8px';
  actions.style.alignItems = 'center';

  const copySecret = document.createElement('button');
  copySecret.className = 'copy-btn';
  copySecret.textContent = 'Copy Secret';
  copySecret.title = 'Salin secret (base32)';
  copySecret.addEventListener('click', ()=>{
    navigator.clipboard.writeText(item.secret).then(()=>{
      showToast('Secret disalin ke clipboard');
      // juga isi field bookmarklet otomatis
      document.getElementById('bookmarkletCode').value = item.secret;
      // update totp preview
      generateTOTPPreview(item.secret);
    }).catch(()=>showToast('Gagal menyalin',2500));
  });

  const copyOtp = document.createElement('button');
  copyOtp.className = 'copy-btn';
  copyOtp.textContent = 'Copy OTP (saat ini)';
  copyOtp.title = 'Generate OTP sekarang dan salin';
  copyOtp.addEventListener('click', async ()=>{
    try{
      const otp = await generateTOTP(item.secret);
      navigator.clipboard.writeText(otp).then(()=>showToast('OTP disalin: ' + otp));
    }catch(err){
      showToast('Gagal generate OTP: ' + err.message,3000);
    }
  });

  actions.appendChild(copySecret);
  actions.appendChild(copyOtp);

  div.appendChild(meta);
  div.appendChild(actions);
  accountsList.appendChild(div);
}

/* Helpers: base32 encode (for byte arrays) */
function base32Encode(bytes) {
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  let bits = 0, value = 0, output = '';
  for (let i = 0; i < bytes.length; i++) {
      value = (value << 8) | bytes[i];
      bits += 8;
      while (bits >= 5) {
          output += alphabet[(value >>> (bits - 5)) & 31];
          bits -= 5;
      }
  }
  if (bits > 0) {
      output += alphabet[(value << (5 - bits)) & 31];
  }
  // pad to multiple of 8 if desired (not necessary)
  return output;
}

/* base32 decode (for generating TOTP) */
function base32Decode(str){
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  const clean = str.toUpperCase().replace(/=+$/,'').replace(/\s+/g,'');
  let bits = 0, value = 0;
  const bytes = [];
  for (let i=0;i<clean.length;i++){
    const idx = alphabet.indexOf(clean[i]);
    if(idx === -1) throw new Error('Invalid Base32 char: ' + clean[i]);
    value = (value << 5) | idx;
    bits += 5;
    if(bits >= 8){
      bytes.push((value >>> (bits - 8)) & 0xFF);
      bits -= 8;
    }
  }
  return new Uint8Array(bytes);
}

/* TOTP generation using Web Crypto Subtle (SHA-1) */
function intToBuffer(e){
  const t=new ArrayBuffer(8), r=new DataView(t);
  const high = Math.floor(e / Math.pow(2,32));
  const low = e >>> 0;
  r.setUint32(0, high);
  r.setUint32(4, low);
  return new Uint8Array(t);
}

async function generateTOTP(secret, digits=6, period=30, algo='SHA-1'){
  if(!secret) throw new Error('Secret kosong');
  const keyBytes = base32Decode(secret);
  const key = await crypto.subtle.importKey('raw', keyBytes, {name:'HMAC', hash:{name:algo}}, false, ['sign']);
  const epoch = Math.floor(Date.now()/1000);
  const counter = Math.floor(epoch/period);
  const data = intToBuffer(counter);
  const sig = await crypto.subtle.sign('HMAC', key, data);
  const res = new Uint8Array(sig);
  const offset = res[res.length - 1] & 0xf;
  const code = ((res[offset] & 0x7f) << 24) | ((res[offset+1] & 0xff) << 16) | ((res[offset+2] & 0xff) << 8) | (res[offset+3] & 0xff);
  const otp = (code % Math.pow(10,digits)).toString().padStart(digits,'0');
  return otp;
}

/* Show preview TOTP */
async function generateTOTPPreview(secret){
  try{
    if(!secret) { document.getElementById('totpPreview').textContent = '‚Äî'; return; }
    const otp = await generateTOTP(secret);
    document.getElementById('totpPreview').textContent = otp;
  }catch(err){
    document.getElementById('totpPreview').textContent = 'Err';
  }
}

/* Escape html helper */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

/* Bookmarklet generator (kept similar logic, improved quoting) */
document.getElementById('generateBtn').addEventListener('click', ()=>{
  const code = document.getElementById("bookmarkletCode").value.trim();
  const namacode = document.getElementById("bookmarkletNama").value.trim();
  const selected2fa = document.querySelector('input[name="bmOption"]:checked').value;

  if(!code){ alert('Masukkan kode secret terlebih dahulu.'); return; }
  if(!namacode){ alert('Masukkan nama bookmark terlebih dahulu.'); return; }

  // The JS to run inside bookmarklet. Keep compact and avoid multiline quotes.
  const jsCode = `
  (function(){
    try{
      var secretKey=${JSON.stringify(code)};
      function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}
      function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}
      function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}
      generateTOTP(secretKey).then(function(tok){
        try{
          var target="${selected2fa}";
          if(target==="infogtk"){
            var els=document.querySelectorAll("#otpForm .otp-input");
            if(els && els.length>0){ tok.split("").forEach(function(c,i){ if(els[i]) els[i].value=c }); return; }
          }
          var el=document.getElementById(target);
          if(el){ el.value=tok; } else {
            // try by name
            var en=document.getElementsByName(target)[0];
            if(en) en.value=tok; else alert("Gagal memasukkan OTP. Elemen dengan id/name: "+target+" tidak ditemukan.");
          }
        }catch(err){ alert("Error saat menempatkan OTP: "+err.message) }
      }).catch(function(err){ alert("Gagal generate OTP: "+err.message) });
    }catch(e){ alert("Bookmarklet Error: "+e.message) }
  })();`;

  // Create bookmarklet URL (minimize by encodeURIComponent)
  const bookmarklet = "javascript:" + encodeURIComponent(jsCode);
  const link = document.getElementById('bookmarkletLink');
  link.href = bookmarklet;
  link.textContent = namacode;
  showToast('Bookmarklet siap. Tarik link ke bookmarks bar atau klik untuk menyimpan.',3500);
});

/* Regenerate totp preview on demand */
document.getElementById('regenTotp').addEventListener('click', ()=>{
  const s = document.getElementById('bookmarkletCode').value.trim();
  if(!s){ showToast('Secret kosong.'); return; }
  generateTOTPPreview(s).then(()=>showToast('TOTP diupdate.')).catch(()=>showToast('Gagal generate TOTP'));
});

/* Sample QR button (optional sample text) */
document.getElementById('sampleBtn').addEventListener('click', ()=>{
  const sample = 'otpauth://totp/Example:demo@example.com?secret=JBSWY3DPEHPK3PXP&issuer=Example';
  // simulate processing
  processQR(sample);
  showToast('Contoh otpauth:// diproses.');
});

/* Initial: if user pastes image data or drags, handled by handlers above */

/* Accessibility: allow paste of otpauth URL via manual prompt (hidden utility) */
window.addEventListener('paste', e=>{
  const text = (e.clipboardData || window.clipboardData).getData('text');
  if(text && (text.startsWith('otpauth://') || text.includes('data='))){
    processQR(text.trim());
    showToast('Mendeteksi otpauth/data di clipboard, diproses.');
  }
});
</script>
</body>
</html>